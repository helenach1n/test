import pygame
import random
import sys

# 初始化Pygame
pygame.init()

# 游戏配置
WIDTH, HEIGHT = 800, 600
screen = pygame.display.set_mode((WIDTH, HEIGHT))
pygame.display.set_caption("打地鼠")
clock = pygame.time.Clock()

# 颜色定义
BROWN = (139, 69, 19)
GREEN = (34, 139, 34)
RED = (255, 0, 0)
WHITE = (255, 255, 255)
BLACK = (0, 0, 0)

# 游戏变量
score = 0
lives = 3
holes = []
mole_timer = 0
MOLE_SPAWN_RATE = 1000  # 地鼠出现间隔（毫秒）
MOLE_STAY_TIME = 1500    # 地鼠停留时间（毫秒）

# 创建洞口位置（5个洞口）
for i in range(5):
    holes.append({
        "x": 100 + i * 150,
        "y": 400,
        "has_mole": False,
        "mole_timer": 0
    })

# 字体
font = pygame.font.Font(None, 36)
large_font = pygame.font.Font(None, 72)

def draw_game():
    # 绘制背景
    screen.fill(GREEN)
    
    # 绘制草地纹理
    for i in range(0, WIDTH, 20):
        pygame.draw.line(screen, (30, 180, 30), (i, 0), (i, HEIGHT), 1)
    for i in range(0, HEIGHT, 20):
        pygame.draw.line(screen, (30, 180, 30), (0, i), (WIDTH, i), 1)
    
    # 绘制洞口
    for hole in holes:
        # 洞口阴影
        pygame.draw.circle(screen, (100, 50, 10), (hole["x"] + 5, hole["y"] + 5), 50)
        # 洞口
        pygame.draw.circle(screen, BROWN, (hole["x"], hole["y"]), 50)
        # 洞口内部
        pygame.draw.circle(screen, (101, 67, 33), (hole["x"], hole["y"]), 40)
        
        # 绘制地鼠
        if hole["has_mole"]:
            # 地鼠身体
            pygame.draw.circle(screen, (128, 128, 128), (hole["x"], hole["y"] - 30), 30)
            # 地鼠脸
            pygame.draw.circle(screen, (150, 150, 150), (hole["x"], hole["y"] - 30), 20)
            # 眼睛
            pygame.draw.circle(screen, BLACK, (hole["x"] - 8, hole["y"] - 35), 5)
            pygame.draw.circle(screen, BLACK, (hole["x"] + 8, hole["y"] - 35), 5)
            # 鼻子
            pygame.draw.circle(screen, (255, 100, 100), (hole["x"], hole["y"] - 25), 4)
            # 嘴巴
            pygame.draw.arc(screen, BLACK, (hole["x"] - 15, hole["y"] - 25, 30, 15), 0, 3.14, 2)
            # 耳朵
            pygame.draw.circle(screen, (128, 128, 128), (hole["x"] - 15, hole["y"] - 55), 10)
            pygame.draw.circle(screen, (128, 128, 128), (hole["x"] + 15, hole["y"] - 55), 10)
    
    # 绘制分数和生命值背景
    pygame.draw.rect(screen, (0, 0, 0, 128), (10, 10, 200, 100), border_radius=10)
    pygame.draw.rect(screen, (0, 0, 0, 128), (WIDTH - 210, 10, 200, 100), border_radius=10)
    
    # 绘制分数和生命值
    score_text = font.render(f"分数: {score}", True, WHITE)
    lives_text = font.render(f"生命: {lives}", True, WHITE)
    screen.blit(score_text, (30, 30))
    screen.blit(lives_text, (WIDTH - 180, 30))
    
    # 绘制生命心形
    heart_x = WIDTH - 180
    heart_y = 70
    for i in range(lives):
        # 简单的心形绘制
        pygame.draw.circle(screen, RED, (heart_x + i * 35, heart_y), 10)
        pygame.draw.circle(screen, RED, (heart_x + i * 35 + 10, heart_y), 10)
        pygame.draw.polygon(screen, RED, [
            (heart_x + i * 35 - 10, heart_y + 5),
            (heart_x + i * 35 + 20, heart_y + 5),
            (heart_x + i * 35 + 5, heart_y + 25)
        ])

def draw_game_over():
    # 半透明覆盖层
    overlay = pygame.Surface((WIDTH, HEIGHT), pygame.SRCALPHA)
    overlay.fill((0, 0, 0, 200))
    screen.blit(overlay, (0, 0))
    
    # 游戏结束文本
    game_over_text = large_font.render("游戏结束!", True, RED)
    score_text = font.render(f"最终分数: {score}", True, WHITE)
    restart_text = font.render("按R键重新开始，按ESC退出", True, WHITE)
    
    screen.blit(game_over_text, (WIDTH//2 - game_over_text.get_width()//2, HEIGHT//2 - 100))
    screen.blit(score_text, (WIDTH//2 - score_text.get_width()//2, HEIGHT//2))
    screen.blit(restart_text, (WIDTH//2 - restart_text.get_width()//2, HEIGHT//2 + 100))

# 主游戏循环
running = True
game_over = False

while running:
    current_time = pygame.time.get_ticks()
    
    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False
            
        if event.type == pygame.KEYDOWN:
            if event.key == pygame.K_ESCAPE:
                running = False
            if game_over and event.key == pygame.K_r:
                # 重新开始游戏
                score = 0
                lives = 3
                holes = []
                mole_timer = 0
                for i in range(5):
                    holes.append({
                        "x": 100 + i * 150,
                        "y": 400,
                        "has_mole": False,
                        "mole_timer": 0
                    })
                game_over = False
                
        if event.type == pygame.MOUSEBUTTONDOWN and not game_over:
            mouse_x, mouse_y = event.pos
            for hole in holes:
                if hole["has_mole"]:
                    # 判断是否点击到地鼠
                    distance = math.sqrt((mouse_x - hole["x"])**2 + (mouse_y - (hole["y"] - 30))**2)
                    if distance <= 30:
                        score += 10
                        hole["has_mole"] = False
                        # 点击音效（如果有音频可以在这里添加）
    
    if not game_over:
        # 地鼠生成逻辑
        if current_time - mole_timer > MOLE_SPAWN_RATE and lives > 0:
            # 随机选择一个空洞口生成地鼠
            empty_holes = [h for h in holes if not h["has_mole"]]
            if empty_holes:
                selected_hole = random.choice(empty_holes)
                selected_hole["has_mole"] = True
                selected_hole["mole_timer"] = current_time
                mole_timer = current_time
        
        # 地鼠消失逻辑
        for hole in holes:
            if hole["has_mole"] and current_time - hole["mole_timer"] > MOLE_STAY_TIME:
                hole["has_mole"] = False
                lives -= 1
        
        # 游戏结束判断
        if lives <= 0:
            game_over = True
    
    # 绘制游戏
    draw_game()
    
    if game_over:
        draw_game_over()
    
    pygame.display.flip()
    clock.tick(60)

pygame.quit()
sys.exit()